#!/bin/sh
# postinst script for igestis-samba
#
# see: dh_installdeb(1)

. /usr/share/debconf/confmodule

# We set some var specific for igestis
MODULE_FOLDER=/usr/share/igestis/modules/OpenChange
GLOBALVARS=${MODULE_FOLDER}/config/ConfigModuleVars.php

replace_value_global_vars()
{

sed -i "s#const[[:space:]]*$1.*#const $1 = $2;#g" $GLOBALVARS
sed_return_value=$?

if [ ! "$sed_return_value" = 0 ] ; then
    echo "error : the variable $1 was not found in the file $GLOBALVARS"
fi

}

get_value_global_vars()
{

grep "^[[:space:]]*const[[:space:]]*$1" $GLOBALVARS | \
  sed "s#^[[:space:]]*const[[:space:]]$1[[:space:]]=[[:space:]]##g" | \
  sed 's/[ ;][[:space:]]*$//g'

}


#DEBHELPER#


case "$1" in
    configure)

    # Config file creation from template.
    if [ -e "$GLOBALVARS" ] ; then

		# Backup of old config file-
        mkdir -p /var/backup/igestis/OpenChange/ && chmod 700 /var/backup/igestis/OpenChange/
		cp $GLOBALVARS /var/backup/igestis/OpenChange/ConfigModuleVars-$(date "+%Y%M%d_%H%M").php.backup

		ucf --debconf-ok ${MODULE_FOLDER}/config/ConfigModuleVars-template.php $GLOBALVARS

	else

        FIRST_INSTALL=true
		cp ${MODULE_FOLDER}/config/ConfigModuleVars-template.php $GLOBALVARS
		
	fi
		
	# Setup the Hostname
	HOSTNAME=$(hostname)
	[ -z "$HOSTNAME" ] && echo "Warning : The hostname has not be defined properly."
	replace_value_global_vars serverName \"${HOSTNAME}\"

    db_get igestis/authentication
    AUTHENTICATION="${RET}"

    ;;

    abort-upgrade|abort-remove|abort-deconfigure)

    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0


